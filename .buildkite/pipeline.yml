env:
  COMMIT_TAG: vitalizer-${BUILDKITE_COMMIT}

steps:
  - label: ":docker: :quay: Build and push"
    agents:
      queue: docker-build
    plugins:
      vital-software/docker-compose#vital-v1.8:
        build:            base
        image_repository: quay.io/vital/build-cache
        image-name:       ${COMMIT_TAG}

  - wait

  - label:   ":eslint: Lint"
    command: yarn lint
    plugins:
      vital-software/docker-compose#vital-v1.8:
        config:
          - docker-compose.yml
          - docker-compose.buildkite.yml
        run: base

  - label:   ":yarn: Simple e2e test"
    command: test/task/e2e-simple.sh
    plugins:
      vital-software/docker-compose#vital-v1.8:
        config:
          - docker-compose.yml
          - docker-compose.buildkite.yml
        run: base

  - wait

  - label: ":npm: Semantic release"
    branches: master
    command: semantic-release
    plugins:
      vital-software/docker-compose#vital-v1.8:
        config:
          - docker-compose.yml
          - docker-compose.buildkite.yml
        run: base
